#!/usr/bin/env bash

set -e
branch=$(git symbolic-ref --short -q HEAD)

root=$(git rev-parse --show-toplevel)

cd $root

git add . && git commit -m. || true

cleanup() {
  cd $root/.git
  rm -f diff.txt message.txt
}

trap cleanup EXIT

set -x

git pull origin $branch

git show-ref --verify --quiet refs/heads/main || (git branch main && git branch --set-upstream-to=origin/main main && git pull && git checkout $branch)

if [ "$branch" != "main" ]; then
  git checkout main
  git pull
  git checkout $branch
  git merge main
  hash=$(git log --pretty=format:'%H %s' | awk '{if (length($2) > 3 && !($2 ~ /^Merge/)) {print $1; exit}}')
  git reset --soft $hash
  git add .

  rm -f .git/message.txt
  git diff origin/main >.git/diff.txt
  PROMPT="查看 @.git/diff.txt , 按约定式提交规范(<type>[optional scope]: <description> / <中文描述>:\n\n- en\n- en\n\n- 中文\n- 中文)写英文/中文双语的git提交信息(描述事实不夸张，文风简明扼要)保存到 @.git/message.txt, 但不要提交"
  # gemini --yolo "$PROMPT" || true
  # if [ ! -f "message.txt" ]; then
  iflow -p "$PROMPT"
  # fi
  git commit --file ./.git/message.txt
  git push -f origin $branch
  git checkout main
  git merge $branch
  git push
  git checkout $branch
fi
