#!/usr/bin/env bash

set -e
branch=$(git symbolic-ref --short -q HEAD)
set -x

root=$(git rev-parse --show-toplevel)
cd $root

if [ "$branch" == "main" ]; then
  git checkout -b dev
fi

LAST_MSG=$(git log -1 --format=%s 2>/dev/null)

git add .
git commit -m .

git pull origin $branch || true

if [ "$LAST_MSG" == "." ]; then
  git reset --soft HEAD~2
  git commit -m.
fi

if [ -z "$NO_PUSH" ]; then
  git push -f
fi
