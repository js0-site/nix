# NixOS 部署：全自动化服务器配置

- [项目简介](#项目简介)
- [功能特性](#功能特性)
- [技术堆栈](#技术堆栈)
- [工作流程](#工作流程)
  - [1. 初始安装 (`setup.js`)](#1-初始安装-setupjs)
  - [2. 更新部署 (`deploy.js`)](#2-更新部署-deployjs)
- [核心设计理念](#核心设计理念)
  - [声明式配置](#声明式配置)
  - [私有配置管理](#私有配置管理)
- [目录结构](#目录结构)
- [使用方法](#使用方法)
- [历史小记](#历史小记)

## 项目简介

本项目提供了一个完整的、声明式的 NixOS 配置，专为在远程服务器上进行自动化部署而设计。它使用 `nixos-anywhere` 进行初始安装，并使用 `nixos-rebuild` 进行后续部署，从而实现全自动、可复现的服务器配置。

该系统能自动检测远程硬件和网络配置，生成量身定制的 NixOS 配置文件，并完成部署。只需几个命令，即可将一台通用 Linux 服务器转变为一个完全配置好的、可复现的 NixOS 实例。

## 功能特性

- **自动化初始设置**: 单一脚本 (`setup.js`) 即可处理系统分析、配置生成和远程安装。
- **多主机部署**: 使用 `deploy.js` 高效地将更新后的配置部署到所有受管服务器。
- **动态硬件与网络检测**: 自动检测 CPU 架构、磁盘设备、网络接口、IP 地址和网关。
- **彻底的声明式设计**: 利用 Nix Flakes 进行依赖管理和完整的系统配置。
- **优化的 Btrfs 布局**: 采用 `disko` 实现精细的 Btrfs 子卷结构，以实现更好的组织和性能。
- **私有配置管理**: 在私有 Git 仓库中安全地管理特定于机器的密钥和配置。

## 技术堆栈

- **[NixOS](https://nixos.org/)**: 一个基于 Nix 包管理器构建的 Linux 发行版，可实现可复现和声明式的系统配置。
- **[Nix Flakes](https://nixos.wiki/wiki/Flakes)**: 管理依赖项并为配置提供标准化的入口点。
- **[nixos-anywhere](https://github.com/nix-community/nixos-anywhere)**: 用于从现有的 Linux 环境将 NixOS 安装到远程计算机。
- **[disko](https://github.com/nix-community/disko)**: 以声明方式处理磁盘格式化和分区。
- **[Btrfs](https://btrfs.wiki.kernel.org/)**: 因其强大的子卷功能而被选用。

## 工作流程

整个过程分为两部分：初始安装和后续部署。

### 1. 初始安装 (`setup.js`)

先编辑 nix/vps/HOST.js 将目标机器的 IP 地址和期望的主机名添加到列表中。

然后运行 ./gen/vps.js 生成配置

然后 SSHPASS="密码" ./setup.js 主机名

`nix/vps/enable.json` 配置要装什么服务

`nix/vps/tailscale.token` 是配置自动登录 tailscale 的，每 90 天要更新一次

`setup.js` 脚本是配置新服务器的入口点。它会自动执行以下步骤：

1.  **连接与分析**: 通过 SSH 连接到目标服务器，并运行 `sh/vpsMeta.sh` 脚本以收集关键系统信息（CPU、磁盘、网络等）。
2.  **生成配置**:
    - `sh/genConf.js` 会创建 `nix/vps/conf.nix` 文件，其中包含本地设置（时区、语言、公钥）。
    - 从服务器收集的硬件/网络元数据用于生成特定于主机的配置文件（例如 `nix/vps/conf/my-server.nix`）。
    - 此配置文件会被提交到私有的 `nix/vps` Git 仓库中。
3.  **安装 NixOS**: 使用 `nixos-anywhere` 工具擦除服务器磁盘，并根据生成的配置安装一个全新的 NixOS 系统。

### 2. 更新部署 (`deploy.js`)

服务器运行 NixOS 后，可使用 `deploy.js` 脚本来推送配置更新。

1.  **获取主机**: 脚本会读取 `nix/vps/host.json` 文件，以获取所有受管主机及其 IP 地址的列表。
2.  **部署**: 使用 `nixos-rebuild switch` 高效地构建配置，并将其部署到目标机器。

## 核心设计理念

### 声明式配置

整个系统都是以声明方式定义的。`flake.nix` 作为入口点，导入了 `nix/` 目录中的一系列模块。每个模块负责系统的特定方面：

- `disk.nix`: 使用 `disko` 定义 Btrfs 分区和子卷布局。
- `net.nix`: 配置静态网络。
- `soft.nix`: 安装系统级软件包并设置环境变量。
- `ssh.nix`: 管理 SSH 访问和密钥。

### 私有配置管理

为了将公共配置与私有数据分离，`nix/vps/` 目录被作为一个私有 Git 仓库进行管理。该目录包含：

- **主机配置文件**: 每台服务器的硬件和网络配置。
- **密钥**: SSH 密钥 (`nix/vps/ssh/`) 和服务令牌 (例如 `nix/vps/tailscale.token`)。
- **主机映射**: 一个 `host.json` 文件，用于将服务器主机名映射到其 IP 地址。

这种分离确保了敏感信息不会在主公共仓库中暴露。

## 目录结构

```
/
├── flake.nix               # Flake 入口点，定义输入并导入主系统配置。
├── setup.js                # 用于在新服务器上进行 NixOS 初始安装的交互式脚本。
├── deploy.js               # 使用 nixos-rebuild 将配置部署到所有受管服务器。
├── rebuild.sh              # 在本地机器上重建 NixOS 配置。
├── sh/
│   ├── genConf.js          # 为部署生成本地配置（时区、语言、SSH 密钥）。
│   ├── vpsMeta.sh          # 在目标服务器上运行以收集硬件和网络元数据的脚本。
│   └── init_git.sh         # 初始化私有的 `nix/vps` git 仓库。
├── nix/
│   ├── sys.nix             # 主 NixOS 模块，整合所有其他配置。
│   ├── configuration.nix   # 基础系统级配置（引导加载程序、sudo 等）。
│   ├── disk.nix            # 使用 `disko` 进行声明式磁盘分区。
│   ├── net.nix             # 静态网络配置（IP、网关、DNS）。
│   ├── ssh.nix             # SSH 服务器和授权密钥配置。
│   ├── soft.nix            # 管理系统级软件包、环境变量和服务。
│   └── vps/                # (私有 Git 仓库) 特定于机器的配置。
│       ├── conf.nix        # 生成的包含本地用户设置的文件。
│       ├── host.json       # 将主机名映射到 IP 地址。
│       ├── conf/           # 存放主机特定的硬件/网络配置文件的目录。
│       └── ssh/            # 服务器的私有 SSH 密钥。
└── readme/
    ├── en.md               # 英文 README
    └── zh.md               # 本文件
```

## 使用方法

### 1. 初始服务器设置

要配置一台新服务器（例如一台全新的 VPS）：

1.  **先决条件**:
    - 确保可以通过 SSH 以 root 权限访问目标机器。
    - 在 `nix/vps/host.json` 中添加服务器的 IP 和期望的主机名。
    - 确保你的 `~/.ssh/id_ed25519.pub` 文件中有 SSH 公钥。
2.  **执行设置**: 在你的本地机器上运行 `setup.js` 脚本，并提供目标 IP 地址。

    ```bash
    # 如果初次连接需要密码认证，请使用 SSHPASS
    SSHPASS=你的密码 ./setup.js <目标 IP>

    # 或者使用密钥认证
    ./setup.js <目标 IP>
    ```

    脚本将连接服务器、收集信息、请求确认（除非使用了 `--yes` 标志），然后安装 NixOS。

### 2. 更新现有服务器

在对 NixOS 配置进行更改后，使用以下命令进行部署：

```bash
./deploy.js [目标IP 或主机名...]
```

如果未指定目标，脚本将部署到 `nix/vps/host.json` 中定义的所有主机。

### 3. 本地重建

如果你在本地机器上运行 NixOS 并希望应用此配置，请使用：

```bash
./rebuild.sh
```

## 历史小记

本项目核心技术 NixOS 起源于 2003 年的一个研究项目。这段旅程始于 Nix 包管理器，由 Eelco Dolstra 在其博士研究期间创建。他的工作引入了一种纯函数式的包管理方法，为实现一个完全声明式的操作系统奠定了基础。

将 Nix 扩展至管理整个操作系统的想法由 Armijn Hemel 实现。他在 2006 年为自己的硕士论文开发了 NixOS 的第一个原型。该原型证明了 Nix 的函数式原则不仅可以应用于软件包，还可以用于系统服务、内核管理和整个操作系统配置，从而实现了今天 NixOS 所特有的原子化升级和可靠回滚功能。